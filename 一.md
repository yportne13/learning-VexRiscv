# VexRiscv 解析（一）

通过[上一篇]()的介绍，相信大家已经对如何设计一个基础的 riscv 处理器有了基本的了解，接下来就让我们步入正题，看看这个大概是前无古人的设计，Vexriscv。

[代码链接](https://github.com/SpinalHDL/VexRiscv)

## 为什么要采用这样一种独特的设计

首先我引用一下夏晶大佬的观点：RISC-V 根本的实质是一个 DSA （domain specific architecture，针对某个应用领域而特别定制的某个架构）扩展的平台。RV 的最大特征是用最小指令集合实现了图灵完备，你只需要在此之上涂上你想要的任意颜色就好了。 也就是说，RISC-V 是天生为了添加自定义指令而存在的。在这种情况下，我们自然会希望有这样一套 riscv 代码，包含完整的 riscv 基础，同时又能方便的扩展自定义指令。使用传统的设计思路构建 riscv 会不可避免的遇见，每当要添加新的指令时，都要在一大堆凌乱的代码中寻找需要修改的部分，加的越多代码越乱。

上一篇介绍的代码是一个有趣的尝试，新的指令可以通过添加新的 extension 的形式引入而不需要修改原先的代码。但是这还不够，这个 extension 还不够灵活，当我们遇到诸如 

在这个背景下，Vexriscv 应运而生。这是个标准的五级流水线处理器，ppa 相当优秀。最重要的是，Vexriscv 应该是迄今为止可配置的参数最多最灵活的 cpu。最重要的是，它具有最方便的添加自定义指令的能力，简单的新建一个 plugin 就能带来一个（或一套）全新的指令。虽然代码对初学者来说很难理解，但掌握后会发现这套代码架构十分清晰。

## 参数架构

先让我们看看 [demo](https://github.com/SpinalHDL/VexRiscv/tree/master/src/main/scala/vexriscv/demo)，这里面每一个文件都是一种配置，从面积最小的五百多个 lut（Artix 7 系）到性能最强的 1.57 DMIPS/Mhz 应有尽有。

让我们选择 `GenFull.scala` 这个文件看看。首先定义了一个 vexriscv 的参数，其中包含一个 plugin 的 list。整个 cpu 的组成都定义为 plugin 了，我们只需要看参数就能知道这个 cpu 有哪些内容。首先是 ibus 和 dbus，在 genfull 中这两个接口都带有 cache，现代计算机中从内存里拿数据从发出请求到拿到数据通常会需要等比较久的时间，因此通常做法是先把接下来可能要用到的都存到 cpu 内部的小存储器中（cache），这样 cpu 就能很快拿到数据。接下来是 mmu，也就是内存管理单元，处理的是内存地址的映射问题，cpu 里算的内存地址和实际的内存地址不一定是对应的可能需要 mmu 来转换一下。译码和寄存器是必备组件。IntAlu 是整数计算单元，src 选择操作数来源，shifter 实现移位操作，hazard 处理竞争冒险，mul、div 添加乘除法操作，csr 处理控制状态寄存器，debug 就是 debug，branch 处理分支跳转，最后 yaml 用来生成配置文件。

## 顶层架构

看完参数，让我们回到顶层代码，看看参数是怎么被利用的。来到 `VexRiscv.scala` 这个文件：

```scala

```

object 内你可以定义各种各样的函数，但有两种是特殊的，一个是 main 函数大家都懂，另一个是这里的 apply 函数，意义是你调用这个 object 的时候其实就是调用 apply 函数。scala 的一个特性是你可以定义多个重名的函数，但接受的参数要不一样，这样 scala 可以在你调用的时候自动分析出你想调用的是哪个。Vexriscv 是一个标准的五级流水线的 cpu，但可以配置成更多或更少级数，这里有两个 apply 函数，简单的那个就是配置成默认的五级流水线，而另一个则是允许你配置是否有 MEM 和 WB 这两个阶段。

接下来让我们看看 VexRiscvConfig 这个类。如果你的模块的参数很复杂的话可以考虑定义一个类来包含所有你要的参数，能让代码可读性和可维护性更高。这个类里除了上面说的东西以外，还有一些函数和一些类似 `object xxx extends Stageable(xxx)` 的东西。函数先放下不谈，先看看 Stageable，其用处是定义各阶段间交互的信号。在上一篇文章所描述的代码中，阶段间是由每个阶段定义的一组 bundle 信号来传递的（inInst 和 outInst），简单直观但却不够灵活。而这里为了实现这个更高级的框架，需要专门设计特殊的数据结构，也就是这里的 Stageable。

## 阶段



## device


